<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Jasmine Chong, Jeff Xia" />

<meta name="date" content="2020-04-15" />

<title>MS Peaks to Pathways</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">MS Peaks to Pathways</h1>
<h4 class="author">Jasmine Chong, Jeff Xia</h4>
<h4 class="date">2020-04-15</h4>



<div id="introduction" class="section level2">
<h2>1. Introduction</h2>
<p>Previous versions of MetaboAnalyst encompassed two modules for functional analysis, metabolic pathway analysis (MetPA) (Xia et al. 2010, <a href="https://academic.oup.com/bioinformatics/article/26/18/2342/208464" class="uri">https://academic.oup.com/bioinformatics/article/26/18/2342/208464</a>) and metabolite set enrichment analysis (MSEA) (Xia et al. 2010, <a href="https://academic.oup.com/nar/article/38/suppl_2/W71/1101310" class="uri">https://academic.oup.com/nar/article/38/suppl_2/W71/1101310</a>). However, these modules require metabolite identifications prior to use, which remains an important challenge in untargeted metabolomics. In comparison, the mummichog algorithm (Li et al. 2013, <a href="http://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1003123" class="uri">http://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1003123</a>) bypasses the bottleneck of metabolite identification prior to pathway analysis, leveraging a priori pathway and network knowledge to directly infer biological activity based on mass peaks. We have therefore implemented the mummichog algorithm in R in a new module named “MS Peaks to Pathways”. The knowledge-base for this module consists of five genome-scale metabolic models from the original Python implementation which have either been manually curated or downloaded from BioCyc, as well as an expanded library of 21 organisms derived from KEGG metabolic pathways.</p>
</div>
<div id="ms-peaks-to-pathways" class="section level2">
<h2>2. MS Peaks to Pathways</h2>
<p>To use this module, users must upload a table (.txt) using the <em>Read.PeakListData</em> function containing either:</p>
<ol style="list-style-type: decimal">
<li>Three columns - m/z features, p-values, and t-scores or fold-change values.</li>
<li>Two columns containing m/z features and either p-values or t-scores</li>
<li>One column ranked by either p-values or t-scores.</li>
<li>Four columns - m/z features, p-values, t-scores or fold-change values, and the mode (positive or negative).</li>
</ol>
<p>All inputted files must be in .txt format. If the input is a three column table, both the mummichog and GSEA algorithms (and their combination) can be applied. If only p-values (or ranked by p-values) are provided, then only the mummichog algorithm will be applied. If only t-scores (or ranked by t-scores) are provided, then only the GSEA algorithm will be applied.</p>
<p>If p-values have not yet been calculated, users can use the “Statistical Analysis” module to upload their raw peak tables, process the data, perform t-tests or fold-change analysis, and then upload these results into the module. With the table, users also need to specify the type of MS instrument, the ion mode (positive or negative) using the <em>UpdateInstrumentParameters</em> function. Currently, MetaboAnalystR only supports the handling of peaks obtained from high-resolution MS instruments such as Orbitrap, or Fourier Transform (FT)-MS instruments as recommended by the original mummichog implementation. Following data upload, users much select the organism’s library from which to perform untargeted pathway analysis using the <em>SetMass.PathLib</em> function. Users can then perform the mummichog algorithm on their data using <em>PerformPSEA</em> (details regarding available algorithms found in MetaboAnalystR 2.0 vignette Section 4). First, users will set algorithm to be used to mummichog using <em>SetPeakEnrichMethod</em>. Second, users will set the p-value cutoff to delineate between significantly enriched and non-significantly enriched m/z features using the <em>SetMummichogPval</em> function. Finally, use the <em>PerformPSEA</em> to calcaulte pathway activity.</p>
<p>The output of this module first consists of a table of results identifying the top-pathways that are enriched in the user-uploaded data, which can be found in your working directory named “mummichog_pathway_enrichment.csv”. The table consists of the total number of hits, the raw p-value (Fisher’s or Hypergeometric), the EASE score, and the adjusted p-value (for permutations) per pathway. A second table can also be found in your working directory named “mummichog_matched_compound_all.csv”, that contains all matched metabolites from the user’s uploaded list of m/z features.</p>
<p>For this tutorial we will first directly use the an example peak list data obtained from untargeted metabolomics of pediatric IBD (mass accuracy 5.0, negative ion mode). This is an example of the three-column table containing the m.z, p.value and t.score.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(MetaboAnalystR)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="co"># Create objects for storing processed data from the MS peaks to pathways module</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">mSet &lt;-<span class="st"> </span><span class="kw">InitDataObjects</span>(<span class="st">&quot;mass_all&quot;</span>, <span class="st">&quot;mummichog&quot;</span>, <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co"># Set the format of the peak list, contains m.z, p.value, and t.score</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw">SetPeakFormat</span>(<span class="st">&quot;mpt&quot;</span>)</a>
<a class="sourceLine" id="cb1-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="co"># Set parameters for analysis, in this case the mass accuracy is set to 5 ppm, the mode of the MS instrument is negative</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10">mSet &lt;-<span class="st"> </span><span class="kw">UpdateInstrumentParameters</span>(mSet, <span class="dv">5</span>, <span class="st">&quot;negative&quot;</span>);</a>
<a class="sourceLine" id="cb1-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="co"># Read in peak-list data</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13">mSet &lt;-<span class="st"> </span><span class="kw">Read.PeakListData</span>(mSet, <span class="st">&quot;https://www.metaboanalyst.ca/MetaboAnalyst/resources/data/mummichog_ibd.txt&quot;</span>);</a>
<a class="sourceLine" id="cb1-14" data-line-number="14"></a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="co"># Sanity check of the uploaded data</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16">mSet &lt;-<span class="st"> </span><span class="kw">SanityCheckMummichogData</span>(mSet)</a>
<a class="sourceLine" id="cb1-17" data-line-number="17"></a>
<a class="sourceLine" id="cb1-18" data-line-number="18"><span class="co"># Perform the mummichog algorithm, in this case the pathway library is from the human MFN model. First set the </span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19"><span class="co"># algorithm to be used to mummichog, then set the p-value cutoff. We're setting the version to &quot;v1&quot;</span></a>
<a class="sourceLine" id="cb1-20" data-line-number="20"><span class="co"># as this data does not contain retention time information.</span></a>
<a class="sourceLine" id="cb1-21" data-line-number="21"><span class="co"># This function may take sometime for processing, and will output the pathway-results and the compound matching tables in your working directory</span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22">mSet&lt;-<span class="kw">SetPeakEnrichMethod</span>(mSet, <span class="st">&quot;mum&quot;</span>, <span class="st">&quot;v1&quot;</span>)</a>
<a class="sourceLine" id="cb1-23" data-line-number="23">mSet&lt;-<span class="kw">SetMummichogPval</span>(mSet, <span class="fl">0.2</span>)</a>
<a class="sourceLine" id="cb1-24" data-line-number="24">mSet&lt;-<span class="kw">PerformPSEA</span>(mSet, <span class="st">&quot;hsa_mfn&quot;</span>, <span class="st">&quot;current&quot;</span>, <span class="dt">permNum =</span> <span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb1-25" data-line-number="25">mSet&lt;-<span class="kw">PlotPeaks2Paths</span>(mSet, <span class="st">&quot;peaks_to_paths_0_&quot;</span>, <span class="st">&quot;png&quot;</span>, <span class="dv">72</span>, <span class="dt">width=</span><span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb1-26" data-line-number="26"></a>
<a class="sourceLine" id="cb1-27" data-line-number="27"><span class="co"># To view the results of the pathway analysis in R, use mSet$mummi.resmat</span></a>
<a class="sourceLine" id="cb1-28" data-line-number="28"></a>
<a class="sourceLine" id="cb1-29" data-line-number="29"><span class="co"># Use this function to view a table of the significant / non-significant compound hits and m/z matching details in a selected pathway</span></a>
<a class="sourceLine" id="cb1-30" data-line-number="30">mSet &lt;-<span class="st"> </span><span class="kw">GetMummichogPathSetDetails</span>(mSet, <span class="st">&quot;Vitamin E metabolism&quot;</span>)</a>
<a class="sourceLine" id="cb1-31" data-line-number="31"></a>
<a class="sourceLine" id="cb1-32" data-line-number="32"><span class="co"># Use this function to view a table of matching details (i.e. adducts, t-scores, m.z) for a compound</span></a>
<a class="sourceLine" id="cb1-33" data-line-number="33">mSet &lt;-<span class="st"> </span><span class="kw">GetCompoundDetails</span>(mSet, <span class="st">&quot;CE5843&quot;</span>)</a></code></pre></div>
<div id="adduct-customization" class="section level3">
<h3>2.1 Adduct Customization</h3>
<p>Raw MS peaks contain a significant amount of adducts specific to their MS instrument and analytical mode. A comprehensive adduct list is shown below in the “Available” panel. Use this to customize the adduct list used by the Mummichog/GSEA algorithms to match m/z peaks to potential compounds hits. The list of available adducts to choose from can be found in <a href="https://github.com/jsychong/MetaboAnalystR/blob/master/pos_add_list.txt">here: positive</a>; <a href="https://github.com/jsychong/MetaboAnalystR/blob/master/neg_add_list.txt">here: negative</a> ; <a href="https://github.com/jsychong/MetaboAnalystR/blob/master/mixed_add_list.txt">here:mixed</a>.</p>
<p>For the negative ion mode, the adducts used are: M-H[-], M-2H[2-], M(C13)-H[-], M(S34)-H[-], M(Cl37)-H[-], M+Na-2H[-], M+K-2H[-], M-H2O-H[-], M+Cl[-], M+Cl37[-], M+Br[-], M+Br81[-], M+ACN-H[-], M+HCOO[-], M+CH3COO[-], and M-H+O[-].</p>
<p>For the positive ion mode, the adducts used are: M[1+], M+H[1+], M+2H[2+], M+3H[3+], M(C13)+H[1+], M(C13)+2H[2+], M(C13)+3H[3+], M(S34)+H[1+], M(Cl37)+H[1+], M+Na[1+], M+H+Na[2+], M+K[1+], M+H2O+H[1+], M-H2O+H[1+], M-H4O2+H[1+], M-NH3+H[1+], M-CO+H[1+], M-CO2+H[1+], M-HCOOH+H[1+], M+HCOONa[1+], M-HCOONa+H[1+], M+NaCl[1+], M-C3H4O2+H[1+], M+HCOOK[1+], and M-HCOOK+H[1+].</p>
</div>
<div id="currency-customization" class="section level3">
<h3>2.2 Currency Customization</h3>
<p>Currency metabolites are abundant substances such as water and carbon dioxide known to occur in normal functioning cells and participate in a large number of metabolic reactions (Huss and Holme, 2007). Because of their ubiquitous nature, removing them can greatly improve pathway analysis and visualization. The list of available currency metabolites can be found <a href="https://github.com/jsychong/MetaboAnalystR/blob/master/currency.txt">here</a>.</p>
<p>By default, the MS Peaks to Paths module considers these metabolites as currency: ‘C00001’, ‘C00080’, ‘C00007’, ‘C00006’, ‘C00005’, ‘C00003’, ‘C00004’, ‘C00002’, ‘C00013’, ‘C00008’, ‘C00009’, ‘C00011’, ‘G11113’, ‘H2O’, ‘H+’, ‘Oxygen’, ‘NADP+’, ‘NADPH’, ‘NAD+’, ‘NADH’, ‘ATP’, ‘Pyrophosphate’, ‘ADP’, ‘Orthophosphate’, and ‘CO2’.</p>
<p>Now we will use another example peak list data obtained from untargeted metabolomics of mice alveolar macrophages in lungs, using an Orbitrap LC-MS (C18 negative ion mode and HILIC positive ion mode). This is an example of the four-column table containing the m.z, mode, p.value, and t.score. We will perform both currency and adduct customization.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># Create objects for storing processed data from the MS peaks to pathways module</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">mSet&lt;-<span class="kw">InitDataObjects</span>(<span class="st">&quot;mass_all&quot;</span>, <span class="st">&quot;mummichog&quot;</span>, <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="co"># Set peak formart - contains m/z features, p-values and t-scores</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="kw">SetPeakFormat</span>(<span class="st">&quot;mpt&quot;</span>)</a>
<a class="sourceLine" id="cb2-6" data-line-number="6"></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">mSet&lt;-<span class="kw">UpdateInstrumentParameters</span>(mSet, <span class="fl">5.0</span>, <span class="st">&quot;mixed&quot;</span>);</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">mSet&lt;-<span class="kw">Read.PeakListData</span>(mSet, <span class="st">&quot;https://www.metaboanalyst.ca/MetaboAnalyst/resources/data/mummichog_mixed.txt&quot;</span>);</a>
<a class="sourceLine" id="cb2-10" data-line-number="10"></a>
<a class="sourceLine" id="cb2-11" data-line-number="11">mSet&lt;-<span class="kw">SanityCheckMummichogData</span>(mSet)</a>
<a class="sourceLine" id="cb2-12" data-line-number="12"></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="co"># Customize currency</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14">curr.vec &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Water (C00001)&quot;</span>,<span class="st">&quot;Proton (C00080)&quot;</span>,<span class="st">&quot;Oxygen (C00007)&quot;</span>,<span class="st">&quot;NADPH (C00005)&quot;</span>,<span class="st">&quot;NADP (C00006)&quot;</span>,<span class="st">&quot;NADH (C00004)&quot;</span>,<span class="st">&quot;NAD (C00003)&quot;</span>,<span class="st">&quot;Adenosine triphosphate (C00002)&quot;</span>,<span class="st">&quot;Pyrophosphate (C00013)&quot;</span>,<span class="st">&quot;Phosphate (C00009)&quot;</span>,<span class="st">&quot;Carbon dioxide (C00011)&quot;</span>,<span class="st">&quot;Hydrogen (C00282)&quot;</span>,<span class="st">&quot;Hydrogen peroxide (C00027)&quot;</span>,<span class="st">&quot;Sodium (C01330)&quot;</span>)</a>
<a class="sourceLine" id="cb2-15" data-line-number="15"></a>
<a class="sourceLine" id="cb2-16" data-line-number="16"><span class="co"># Map selected currency to user's data</span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17">mSet&lt;-<span class="kw">Setup.MapData</span>(mSet, curr.vec);</a>
<a class="sourceLine" id="cb2-18" data-line-number="18">mSet&lt;-<span class="kw">PerformCurrencyMapping</span>(mSet)</a>
<a class="sourceLine" id="cb2-19" data-line-number="19"></a>
<a class="sourceLine" id="cb2-20" data-line-number="20"><span class="co"># Now customize adducts</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21">add.vec &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;M [1+]&quot;</span>,<span class="st">&quot;M+H [1+]&quot;</span>,<span class="st">&quot;M+2H [2+]&quot;</span>,<span class="st">&quot;M+3H [3+]&quot;</span>,<span class="st">&quot;M+Na [1+]&quot;</span>,<span class="st">&quot;M+H+Na [2+]&quot;</span>,<span class="st">&quot;M+K [1+]&quot;</span>,<span class="st">&quot;M+H2O+H [1+]&quot;</span>,<span class="st">&quot;M-H2O+H [1+]&quot;</span>,<span class="st">&quot;M-H4O2+H [1+]&quot;</span>,<span class="st">&quot;M(C13)+H [1+]&quot;</span>,<span class="st">&quot;M(C13)+2H [2+]&quot;</span>,<span class="st">&quot;M(C13)+3H [3+]&quot;</span>,<span class="st">&quot;M(Cl37)+H [1+]&quot;</span>,<span class="st">&quot;M-NH3+H [1+]&quot;</span>,<span class="st">&quot;M-CO+H [1+]&quot;</span>,<span class="st">&quot;M-CO2+H [1+]&quot;</span>,<span class="st">&quot;M-HCOOH+H [1+]&quot;</span>,<span class="st">&quot;M+HCOONa [1+]&quot;</span>,<span class="st">&quot;M-HCOONa+H [1+]&quot;</span>,<span class="st">&quot;M+NaCl [1+]&quot;</span>,<span class="st">&quot;M-C3H4O2+H [1+]&quot;</span>,<span class="st">&quot;M+HCOOK [1+]&quot;</span>,<span class="st">&quot;M-HCOOK+H [1+]&quot;</span>,<span class="st">&quot;M-H [1-]&quot;</span>,<span class="st">&quot;M-2H [2-]&quot;</span>,<span class="st">&quot;M-H2O-H [1-]&quot;</span>,<span class="st">&quot;M-H+O [1-]&quot;</span>,<span class="st">&quot;M+K-2H [1-]&quot;</span>,<span class="st">&quot;M+Na-2H [1- ]&quot;</span>,<span class="st">&quot;M+Cl [1-]&quot;</span>,<span class="st">&quot;M+Cl37 [1-]&quot;</span>,<span class="st">&quot;M+HCOO [1-]&quot;</span>,<span class="st">&quot;M+CH3COO [1-]&quot;</span>)</a>
<a class="sourceLine" id="cb2-22" data-line-number="22"></a>
<a class="sourceLine" id="cb2-23" data-line-number="23"><span class="co"># Set up the selected adducts</span></a>
<a class="sourceLine" id="cb2-24" data-line-number="24">mSet&lt;-<span class="kw">Setup.AdductData</span>(mSet, add.vec);</a>
<a class="sourceLine" id="cb2-25" data-line-number="25">mSet&lt;-<span class="kw">PerformAdductMapping</span>(mSet, <span class="st">&quot;mixed&quot;</span>)</a>
<a class="sourceLine" id="cb2-26" data-line-number="26"></a>
<a class="sourceLine" id="cb2-27" data-line-number="27"><span class="co"># Perform mummichog algorithm using selected currency and adducts, using Version1 of the mummichog algorithm</span></a>
<a class="sourceLine" id="cb2-28" data-line-number="28">mSet&lt;-<span class="kw">SetPeakEnrichMethod</span>(mSet, <span class="st">&quot;mum&quot;</span>, <span class="st">&quot;v1&quot;</span>)</a>
<a class="sourceLine" id="cb2-29" data-line-number="29"></a>
<a class="sourceLine" id="cb2-30" data-line-number="30">mSet&lt;-<span class="kw">SetMummichogPval</span>(mSet, <span class="fl">1.0E-5</span>)</a>
<a class="sourceLine" id="cb2-31" data-line-number="31"></a>
<a class="sourceLine" id="cb2-32" data-line-number="32">mSet&lt;-<span class="kw">PerformPSEA</span>(mSet, <span class="st">&quot;hsa_mfn&quot;</span>, <span class="st">&quot;current&quot;</span>, <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb2-33" data-line-number="33"></a>
<a class="sourceLine" id="cb2-34" data-line-number="34">mSet&lt;-<span class="kw">PlotPeaks2Paths</span>(mSet, <span class="st">&quot;peaks_to_paths_0_&quot;</span>, <span class="st">&quot;png&quot;</span>, <span class="dv">72</span>, <span class="dt">width=</span><span class="ot">NA</span>)</a></code></pre></div>
</div>
<div id="retention-time-integration" class="section level3">
<h3>2.3 Retention Time Integration</h3>
<p>The <em>SetPeakEnrichMethod</em> now has a parameter to let users select whether to use Version 1 or Version 2 of the MS Peaks to Paths algorithms. With Version 2, users can now upload retention time information to perform pathway analysis. Note that Version 2 should only be used if user’s data contains a retention time (“rt” or “r.t”) column. Retention time is used to move pathway analysis from the “Compound” space to “Empirical Compound” space (details below in “How are Empirical Compounds calculated?”). The inclusion of retention time will increase the confidence and robustness of the potential compound matches. Another difference is that currency compounds are removed directly from the user’s selected pathway library, versus removed from potential compound hits during the permutations.</p>
<div id="how-are-empirical-compounds-calculated" class="section level4">
<h4>2.3.1 How are Empirical Compounds calculated?</h4>
<p>Empirical Compounds are intermediaries between m/z features and compounds. The steps for how they are formed are as follows:</p>
<ol style="list-style-type: decimal">
<li><p>As in version 1, all m/z features are matched to potential compounds considering different adducts. Then, per compound, all matching m/z features are split into Empirical Compounds based on whether they match within an expected retention time window. The retention time window (in seconds) is calculated as the maximum retention time * 0.02. This results in the initial Empirical Compounds list.</p></li>
<li><p>Next, Empirical Compounds are merged if they have the same m/z, matched form/ion, and retention time. This results in the merged Empirical Compounds list.</p></li>
<li><p>Finally, if primary ions are enforced, only Empirical Compounds containing at least 1 primary ion are kept. Primary ions considered are ‘M+H[1+]’, ‘M+Na[1+]’, ‘M-H2O+H[1+]’, ‘M-H[-]’, ‘M-2H[2-]’, ‘M-H2O-H[-]’, ‘M+H [1+]’, ‘M+Na [1+]’, ‘M-H2O+H [1+]’, ‘M-H [1-]’, ‘M-2H [2-]’, and ‘M-H2O-H [1-]’. This results in the final Empirical Compounds list.</p></li>
<li><p>Next, pathway libraries are converted from “Compound” space to “Empirical Compound” space. This is done by converting all compounds in each pathway to all Empirical Compound matches. Then the mummichog/GSEA algorithms work as before to calculate pathway enrichment.</p></li>
</ol>
<p>For this tutorial we will use the same example peak list data obtained from untargeted metabolomics of pediatric IBD (mass accuracy 5.0, negative ion mode). This time however, retention time information is included for a four-column table with the following headers: “m.z”, “p.value”, “t.score” and “r.t”.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">mSet&lt;-<span class="kw">InitDataObjects</span>(<span class="st">&quot;mass_all&quot;</span>, <span class="st">&quot;mummichog&quot;</span>, <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">SetPeakFormat</span>(<span class="st">&quot;mprt&quot;</span>)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">mSet&lt;-<span class="kw">UpdateInstrumentParameters</span>(mSet, <span class="fl">5.0</span>, <span class="st">&quot;negative&quot;</span>);</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">mSet&lt;-<span class="kw">Read.PeakListData</span>(mSet, <span class="st">&quot;https://www.metaboanalyst.ca/MetaboAnalyst/resources/data/mummichog_rt.txt&quot;</span>);</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">mSet&lt;-<span class="kw">SanityCheckMummichogData</span>(mSet)</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">mSet&lt;-<span class="kw">SetPeakEnrichMethod</span>(mSet, <span class="st">&quot;mum&quot;</span>, <span class="st">&quot;v2&quot;</span>)</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">mSet&lt;-<span class="kw">SetMummichogPval</span>(mSet, <span class="fl">0.2</span>)</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">mSet&lt;-<span class="kw">PerformPSEA</span>(mSet, <span class="st">&quot;hsa_mfn&quot;</span>, <span class="st">&quot;current&quot;</span>, <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">mSet&lt;-<span class="kw">PlotPeaks2Paths</span>(mSet, <span class="st">&quot;peaks_to_paths_0_&quot;</span>, <span class="st">&quot;png&quot;</span>, <span class="dv">300</span>, <span class="dt">width=</span><span class="ot">NA</span>)</a></code></pre></div>
</div>
<div id="customizing-empirical-compound-formation" class="section level4">
<h4>2.3.2 Customizing Empirical Compound Formation</h4>
<p>By default, V2 of the MS Peaks to Pathways algorithms enforces primary ions to be present when creating Empirical Compounds (step 3 above). Users can disable this in the <em>UpdateInstrumentParameters</em> function by setting the “force_primary_ion” parameter to “no”. Additionally, by default the retention-time window used to split Empirical Compounds is calculated as the maximum retention time in the user’s data multiplied by the retention time fraction (default is 0.02). Users can either change the retention time fraction (rt_frac) or set the retention time-window (rt_tol - in seconds). Code details are shown below.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># Disable force primary ion</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">mSet &lt;-<span class="st"> </span><span class="kw">UpdateInstrumentParameters</span>(mSet, instrumentOpt, msModeOpt, </a>
<a class="sourceLine" id="cb4-3" data-line-number="3">                                   <span class="dt">force_primary_ion =</span> <span class="st">&quot;no&quot;</span>, <span class="dt">rt_frac =</span> <span class="fl">0.02</span>, </a>
<a class="sourceLine" id="cb4-4" data-line-number="4">                                   <span class="dt">rt_tol =</span> <span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb4-5" data-line-number="5"></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co"># Change retention time fraction when calculating the retention time window</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">mSet &lt;-<span class="st"> </span><span class="kw">UpdateInstrumentParameters</span>(mSet, instrumentOpt, msModeOpt, </a>
<a class="sourceLine" id="cb4-8" data-line-number="8">                                   <span class="dt">force_primary_ion =</span> <span class="st">&quot;yes&quot;</span>, <span class="dt">rt_frac =</span> <span class="fl">0.025</span>, </a>
<a class="sourceLine" id="cb4-9" data-line-number="9">                                   <span class="dt">rt_tol =</span> <span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb4-10" data-line-number="10"></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="co"># Set the retention time window (in seconds)</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">mSet &lt;-<span class="st"> </span><span class="kw">UpdateInstrumentParameters</span>(mSet, instrumentOpt, msModeOpt, </a>
<a class="sourceLine" id="cb4-13" data-line-number="13">                                   <span class="dt">force_primary_ion =</span> <span class="st">&quot;yes&quot;</span>, <span class="dt">rt_frac =</span> <span class="fl">0.02</span>, </a>
<a class="sourceLine" id="cb4-14" data-line-number="14">                                   <span class="dt">rt_tol =</span> <span class="dv">25</span>)</a></code></pre></div>
</div>
</div>
</div>
<div id="sweave-report" class="section level2">
<h2>3. Sweave Report</h2>
<p>Following analysis, a comprehensive report can be generated which contains a detailed description of each step performed in the R package, embedded with graphical and tabular outputs. To prepare the sweave report, please use the <em>PreparePDFReport</em> function. You must ensure that you have the nexessary Latex libraries to generate the report (i.e. pdflatex, LaTexiT). The object created <em>must</em> be named <em>mSet</em>, and specify the user name in quotation marks.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">PreparePDFReport</span>(mSet, <span class="st">&quot;My Name&quot;</span>)</a></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
