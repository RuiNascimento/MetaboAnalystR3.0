<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Jasmine Chong, Jeff Xia" />

<meta name="date" content="2020-03-17" />

<title>Biomarker Analysis</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Biomarker Analysis</h1>
<h4 class="author">Jasmine Chong, Jeff Xia</h4>
<h4 class="date">2020-03-17</h4>



<div id="introduction" class="section level2">
<h2>1. Introduction</h2>
<p>The metabolome is well-known to be a sensitive measure of health and disease, reflecting alterations to the genome, proteome, and transcriptome, as well as changes in life-style and environment. As such, one common goal of metabolomic studies is biomarker discovery, aiming to identify a metabolite or a set of metabolites capable of classifying conditions or disease, with high sensitivity (true-positive rate) and specificity (true negative rate). This is achieved through building predictive models of one or multiple metabolites and evaluating the performance, or robustness of the model, to classify new patients into diseased or healthy categories. The main steps for biomarker analysis are as follows:</p>
<ol style="list-style-type: decimal">
<li><p>Biomarker selection</p></li>
<li><p>Performance evaluation</p></li>
<li><p>Model creation</p></li>
</ol>
<p>MetaboAnalystR provides users with several options for single (classical) or multiple biomarker analysis, as well as for predictive biomarker model creation and evaluation.</p>
<p>For a comprehensive introductory tutorial and further details concerning biomarker analysis, please refer to Xia et al. 2013 (PMID: 23543913).</p>
</div>
<div id="importing-data" class="section level2">
<h2>2. Importing data</h2>
<p>The biomarker analysis module accepts either a compound concentration table, spectral binned data, or a peak intensity table. The format of the data must be specified, identifying whether the samples are in rows or columns, and whether or not the data is paired. The data may either be .csv or .txt files. For the biomarker analysis vignette, we will be using the <strong>plasma_nmr.csv</strong> file which can be found online. The data follows the uploading, processing, and filtering steps as per other modules. For information on these steps, please refer to the <em>Introduction to MetaboAnalystR</em> vignette for details.</p>
<p>The normalization step for biomarker analysis, however, includes an additional option for calculating ratios between metabolite concentrations. Ratios between two metabolite concentrations may provide more information than the two individual metabolite concentrations seperately. MetaboAnalystR will compute ratios between all possible metabolite pairs and then choose the top ranked ratios (based on p-values) to be included with the data for further biomarker analysis. Please note, there is a potential overfitting issue associated with this procedure. The main purpose of computing ratios of metabolite concentrations is to improve the chances of biomarker discovery, therefore users will need to validate their performance in future, independent studies. Log normalization of the data will be performed during the process. If you would like to perform data scaling, perform it separately in a second step.</p>
<p>For the tutorial, we will be using a dataset consisting of metabolite concentrations of 90 human plasma samples measured by 1H NMR. Phenotype labels: 0 - Controls; 1 - Patients.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(MetaboAnalystR)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="co"># Create objects for storing processed data from biomarker analysis </span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">mSet&lt;-<span class="kw">InitDataObjects</span>(<span class="st">&quot;conc&quot;</span>, <span class="st">&quot;roc&quot;</span>, <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>## Starting Rserve:
##  /usr/lib/R/bin/R CMD /home/xialab/R/x86_64-pc-linux-gnu-library/3.6/Rserve/libs//Rserve --no-save 
## 
## [1] &quot;MetaboAnalyst R objects initialized ...&quot;</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># Read in data and fill in the dataSet list</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">mSet&lt;-<span class="kw">Read.TextData</span>(mSet, <span class="st">&quot;http://www.metaboanalyst.ca/MetaboAnalyst/resources/data/plasma_nmr_new.csv&quot;</span>, <span class="st">&quot;rowu&quot;</span>, <span class="st">&quot;disc&quot;</span>)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co"># Sanity check, replace missing values, check if the sample size is too small</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5">mSet&lt;-<span class="kw">SanityCheckData</span>(mSet)</a></code></pre></div>
<pre><code>##  [1] &quot;Successfully passed sanity check!&quot;                                                                    
##  [2] &quot;Samples are not paired.&quot;                                                                              
##  [3] &quot;3 groups were detected in samples.&quot;                                                                   
##  [4] &quot;Only English letters, numbers, underscore, hyphen and forward slash (/) are allowed.&quot;                 
##  [5] &quot;&lt;font color=\&quot;orange\&quot;&gt;Other special characters or punctuations (if any) will be stripped off.&lt;/font&gt;&quot;
##  [6] &quot;All data values are numeric.&quot;                                                                         
##  [7] &quot;A total of 0 (0%) missing values were detected.&quot;                                                      
##  [8] &quot;&lt;u&gt;By default, these values will be replaced by a small value.&lt;/u&gt;&quot;                                   
##  [9] &quot;Click &lt;b&gt;Skip&lt;/b&gt; button if you accept the default practice&quot;                                          
## [10] &quot;Or click &lt;b&gt;Missing value imputation&lt;/b&gt; to use other methods&quot;</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">mSet&lt;-<span class="kw">ReplaceMin</span>(mSet)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">mSet&lt;-<span class="kw">IsSmallSmplSize</span>(mSet)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">mSet&lt;-<span class="kw">PreparePrenormData</span>(mSet)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co">###### *** OPTION 1 FOR NORMALIZATION</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co"># Perform no normalization, no ratio calculation</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">mSet&lt;-<span class="kw">Normalization</span>(mSet, <span class="st">&quot;NULL&quot;</span>, <span class="st">&quot;NULL&quot;</span>, <span class="st">&quot;NULL&quot;</span>, <span class="dt">ref=</span><span class="ot">NULL</span>, <span class="dt">ratio=</span><span class="ot">FALSE</span>, <span class="dt">ratioNum=</span><span class="dv">20</span>)</a></code></pre></div>
<p>To perform normalization with ratio calculation use Option 2…</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co">###### *** OPTION 2 FOR NORMALIZATION</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="co"># No normalization, and computeS metabolite ratios and includeS the top 20 </span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">mSet&lt;-<span class="kw">Normalization</span>(mSet, <span class="st">&quot;NULL&quot;</span>, <span class="st">&quot;NULL&quot;</span>, <span class="st">&quot;NULL&quot;</span>, <span class="st">&quot;C01&quot;</span>, <span class="dt">ratio=</span><span class="ot">TRUE</span>, <span class="dt">ratioNum=</span><span class="dv">20</span>)</a>
<a class="sourceLine" id="cb8-4" data-line-number="4"></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="co"># If ratio = TRUE: view the normalized dataset including the top ranked ratios</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="co"># The ratios will be towards the end of the matrix </span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7">mSet<span class="op">$</span>dataSet<span class="op">$</span>norm</a>
<a class="sourceLine" id="cb8-8" data-line-number="8"></a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="co">#If ratio = TRUE: view just the top ranked included ratios</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10">mSet<span class="op">$</span>dataSet<span class="op">$</span>ratio</a></code></pre></div>
</div>
<div id="classical-roc-curve-analysis" class="section level2">
<h2>3. Classical ROC Curve Analysis</h2>
<p>To perform classical ROC curve analysis, you must first set the analysis mode to “univ” using <em>SetAnalysisMode</em>. The second step is to prepare the data for biomarker analysis using <em>PrepareROCData</em>. The third step is to perform the univariate ROC curve analysis with <em>Perform.UnivROC</em>. This function must be called for each feature separately. You must specify whether or not to compute the 95% confidence interval band (isAUC), whether or not to compute the optimal cutoff (isOpt), and whether to calculate a full AUC or partial AUC (isPartial). Note that when performing univariate ROC curve analysis on metabolite ratio pairs, you cannot include a &quot;&quot; in the image name (imgName).</p>
<p>Use the <em>CalculateFeatureRanking</em> function to calculate the feature importance, ranked by order of most to least important, based on AUC. This creates a CSV file titled “metaboanalyst_roc_univ.csv” including the AUC, p-value, and log-2-fold-change for each metabolite feature. Keep the name “feat.rank.mat” to ensure that the sweave report will work.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co"># Set the biomarker analysis mode to perform Classical ROC curve analysis (&quot;univ&quot;)</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">mSet&lt;-<span class="kw">SetAnalysisMode</span>(mSet, <span class="st">&quot;univ&quot;</span>)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co"># Prepare data for biomarker analysis</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">mSet&lt;-<span class="kw">PrepareROCData</span>(mSet)</a>
<a class="sourceLine" id="cb9-6" data-line-number="6"></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="co">### OPTION 1 Perform univariate ROC curve analysis </span><span class="al">###</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8">mSet&lt;-<span class="kw">Perform.UnivROC</span>(mSet, <span class="dt">feat.nm =</span> <span class="st">&quot;Isoleucine&quot;</span>, <span class="dt">imgName =</span> <span class="st">&quot;Isoleucine&quot;</span>, <span class="st">&quot;png&quot;</span>, <span class="dt">dpi=</span><span class="dv">300</span>, <span class="dt">isAUC=</span>F, <span class="dt">isOpt=</span>T, <span class="dt">optMethod=</span><span class="st">&quot;closest.topleft&quot;</span>, <span class="dt">isPartial=</span>F, <span class="dt">measure=</span><span class="st">&quot;sp&quot;</span>, <span class="dt">cutoff=</span><span class="fl">0.2</span>)</a>
<a class="sourceLine" id="cb9-9" data-line-number="9"></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="co"># Create box plot showing the concentrations of the selected compound between the groups</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11">mSet&lt;-<span class="kw">PlotBoxPlot</span>(mSet, <span class="st">&quot;Isoleucine&quot;</span>, <span class="st">&quot;Isoleucineboxplot_0_&quot;</span>, <span class="st">&quot;png&quot;</span>, <span class="dv">72</span>, T, <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb9-12" data-line-number="12"></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"><span class="co"># Perform calculation of feature importance (AUC, p value, fold change)</span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14">mSet&lt;-<span class="kw">CalculateFeatureRanking</span>(mSet)</a></code></pre></div>
<p>Other options are also available to perform univariate ROC curve analysis, as exemplified below:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co">### OPTION 2 Perform univariate ROC curve analysis, resulting in a partial AUC with a 95% CI band </span><span class="al">###</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">mSet&lt;-<span class="kw">Perform.UnivROC</span>(mSet, <span class="dt">feat.nm =</span> <span class="st">&quot;Valine&quot;</span>, <span class="dt">imgName =</span> <span class="st">&quot;Valine&quot;</span>, <span class="st">&quot;png&quot;</span>, <span class="dt">dpi=</span><span class="dv">300</span>, <span class="dt">isAUC=</span>T, <span class="dt">isOpt=</span>T, <span class="dt">optMethod=</span><span class="st">&quot;closest.topleft&quot;</span>, <span class="dt">isPartial=</span>T, <span class="dt">measure=</span><span class="st">&quot;se&quot;</span>, <span class="dt">cutoff=</span><span class="fl">0.2</span>)</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="co">### OPTION 3 Perform univariate ROC curve analysis on a metabolite ratio pair, note that you cannot save an image with a &quot;\&quot; in the name </span><span class="al">###</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">mSet&lt;-<span class="kw">Perform.UnivROC</span>(mSet, <span class="dt">feat.nm =</span> <span class="st">&quot;Isoleucine/Valine&quot;</span>, <span class="dt">imgName =</span> <span class="st">&quot;IsoleucineValine&quot;</span>, <span class="st">&quot;png&quot;</span>, <span class="dt">dpi=</span><span class="dv">300</span>, <span class="dt">isAUC=</span>T, <span class="dt">isOpt=</span>T, <span class="dt">optMethod=</span><span class="st">&quot;closest.topleft&quot;</span>, <span class="dt">isPartial=</span>T, <span class="dt">measure=</span><span class="st">&quot;se&quot;</span>, <span class="dt">cutoff=</span><span class="fl">0.2</span>)</a></code></pre></div>
</div>
<div id="multivariate-roc-curve-explorer" class="section level2">
<h2>4. Multivariate ROC Curve Explorer</h2>
<p>The aim of the multivariate exploratory ROC curve analysis is to evaluate the performance of biomarker models created through an automated important feature identification step. To perform multivariate ROC curve exploration, you must set the analysis mode to “explore” using <em>SetAnalysisMode</em>. The second step is to prepare the data for biomarker analysis using <em>PrepareROCData</em>. The third step is to perform the multivariate ROC curve analysis with <em>PerformCV.explore</em>. This function creates ROC curves generated through Monte-Carlo cross validation (MCCV) using balanced subsampling. In each MCCV, part of the samples are used to evaluate feature importance, and the remaining samples are used to validate the models created with the first step. The top ranking features (max top 100) in terms of importance are used to build the biomarker classification models. This is repeated several times to calculate the performance and confidence intervals of each model. At minimum, users must specify the classification method (cls.method) and the ranking method (rank.method). There are three multivariate algorithms used for ROC curve analysis, partial least squares discriminant analysis (PLS-DA), random forest, and support vector machines (SVM). For PLS-DA classification, users have the option to input the number of latent variables (lvNum), by default it is 2. As well, users may change the proportion of samples to use for training (propTraining). By default, propTraining = 2/3. For users with large datasets (&gt; 1000 features), the univariate feature ranking method is recommended to avoid long computation times.</p>
<p>There are several options to visualize the multivariate ROC curve exploration. The <em>PlotROC</em> function creates a plot of ROC curves for all of the top biomarker models or a single biomarker model based on its average performance across all Monte-Carlo cross validation runs. For a single biomarker, the 95% confidence interval can be computed (show.conf = 1). Meanwhile, the <em>PlotProbView</em> function creates a plot of the predicted class probabilities of all samples using a single biomarker model. Users have the option to label wrongly classified samples. The <em>PlotAccuracy</em> function creates a plot of the predictive accuracy of the top biomarker models with an increasing number of features on the x-axis. Finally, the <em>PlotImpVars</em> function creates a plot of the top ranked important variables of a selected model. Users have the option to change the number of important features to include in the plot (feat.num) as well as the method to rank the features by (measure).</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co"># Set the biomarker analysis mode to perform Multivariate exploratory ROC curve analysis (&quot;explore&quot;)</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">mSet&lt;-<span class="kw">SetAnalysisMode</span>(mSet, <span class="st">&quot;explore&quot;</span>)</a>
<a class="sourceLine" id="cb11-3" data-line-number="3"></a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="co"># Prepare data for biomarker analysis</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5">mSet&lt;-<span class="kw">PrepareROCData</span>(mSet)</a>
<a class="sourceLine" id="cb11-6" data-line-number="6"></a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="co"># Perform multivariate ROC curve analysis, using SVM classification and ranking</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8">mSet&lt;-<span class="kw">PerformCV.explore</span>(mSet, <span class="dt">cls.method =</span> <span class="st">&quot;svm&quot;</span>, <span class="dt">rank.method =</span> <span class="st">&quot;svm&quot;</span>, <span class="dt">lvNum =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb11-9" data-line-number="9"></a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="co">### OPTION 1 Comparison plot of ROC curves of all models </span><span class="al">###</span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11">mSet&lt;-<span class="kw">PlotROC</span>(mSet, <span class="dt">imgName =</span> <span class="st">&quot;ROC_all_models&quot;</span>, <span class="dt">format =</span> <span class="st">&quot;png&quot;</span>, <span class="dt">dpi =</span> <span class="dv">300</span>, <span class="dt">mdl.inx=</span> <span class="dv">0</span>, <span class="dt">avg.method =</span> <span class="st">&quot;threshold&quot;</span>, <span class="dt">show.conf =</span> <span class="dv">0</span>, <span class="dt">show.holdout =</span> <span class="dv">0</span>, <span class="dt">focus=</span><span class="st">&quot;fpr&quot;</span>, <span class="dt">cutoff=</span><span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb11-12" data-line-number="12"></a>
<a class="sourceLine" id="cb11-13" data-line-number="13"><span class="co"># Plot predicted class probabilities for each sample for a selected model, not showing labels of wrongly classified samples</span></a>
<a class="sourceLine" id="cb11-14" data-line-number="14">mSet&lt;-<span class="kw">PlotProbView</span>(mSet, <span class="dt">imgName =</span> <span class="st">&quot;multi_roc_prob&quot;</span>, <span class="dt">format =</span> <span class="st">&quot;png&quot;</span>, <span class="dt">dpi =</span> <span class="dv">300</span>, <span class="dt">mdl.inx =</span> <span class="dv">-1</span>, <span class="dt">show =</span> <span class="dv">0</span>, <span class="dt">showPred =</span> <span class="dv">0</span>)</a></code></pre></div>
<pre><code>## [1] &quot;1585 duplicates are merged to their average&quot;</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co"># Plot the predictive accuracy of models with increasing number of features</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">mSet&lt;-<span class="kw">PlotAccuracy</span>(mSet, <span class="dt">imgName =</span> <span class="st">&quot;multi_roc_accuracy&quot;</span>, <span class="dt">format =</span> <span class="st">&quot;png&quot;</span>, <span class="dt">dpi =</span> <span class="dv">300</span>)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3"></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co"># Plot the most important features of a selected model ranked from most to least important</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5">mSet&lt;-<span class="kw">PlotImpVars</span>(mSet, <span class="dt">imgName =</span> <span class="st">&quot;multi_roc_impvar&quot;</span>, <span class="dt">format=</span><span class="st">&quot;png&quot;</span>, <span class="dt">dpi=</span><span class="dv">300</span>, <span class="dt">mdl.inx =</span> <span class="dv">-1</span>, <span class="dt">measure=</span><span class="st">&quot;freq&quot;</span>, <span class="dt">feat.num=</span><span class="dv">15</span>)</a></code></pre></div>
<p>The above workflow plotted ROC curves for all models, to plot the ROC curve for a single model instead use:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co">### OPTION 2 Plot the ROC curve of a single selected model, in this case model 1 and display the confidence interval </span><span class="al">###</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">mSet&lt;-<span class="kw">PlotROC</span>(mSet, <span class="dt">imgName =</span> <span class="st">&quot;ROC_model1&quot;</span>, <span class="dt">format =</span> <span class="st">&quot;png&quot;</span>, <span class="dt">dpi =</span> <span class="dv">300</span>, <span class="dt">mdl.inx =</span> <span class="dv">1</span>, <span class="dt">avg.method =</span> <span class="st">&quot;threshold&quot;</span>, <span class="dt">show.conf =</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="st">&quot;fpr&quot;</span>, <span class="fl">0.2</span>)</a></code></pre></div>
<p>Some users may wish to extract a selected model. For instance, say the best model has 10 variables. To view the top-ranked 10 variables use the code below. This will return a 2-column matrix with all the variable ranked by how best they perform.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">imp.feats &lt;-<span class="st"> </span><span class="kw">GetImpFeatureMat</span>(mSet, mSet<span class="op">$</span>analSet<span class="op">$</span>multiROC<span class="op">$</span>imp.cv, <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb15-2" data-line-number="2"></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="kw">head</span>(imp.feats)</a>
<a class="sourceLine" id="cb15-4" data-line-number="4"></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="co">#                       Rank Freq. Importance</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="co"># Glycerol                     0.82 0.15103973</span></a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="co"># Methionine                   0.60 0.08181467</span></a>
<a class="sourceLine" id="cb15-8" data-line-number="8"><span class="co"># Acetate                      0.40 0.06299938</span></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="co"># Betaine                      0.36 0.06840905</span></a></code></pre></div>
</div>
<div id="roc-curve-based-model-creation-and-evaluation" class="section level2">
<h2>5. ROC Curve Based Model Creation and Evaluation</h2>
<p>The aim of ROC curve based model creation and evaluation is to allow users to manually select any combination of features to create biomarker models using any of the three algorithms mentioned previously (PLS-DA, SVM, RF). To do this, follow the <em>selected.nms</em> example in the R code chunk below, which selects the names of the features to use to build a ROC biomarker model. This module also allows users to withhold a subset of samples for extra validation purposes. Follow the <em>selected.smpls</em> example below to select the subset of samples to be withheld. Finally, this module also allows users to predict class labels of new samples (samples without class labels). Features should be selected based on the user’s own judgement or prior knowledge. Note, selection of features based solely on their overall ranks (AUC, T-statistic or fold changes) increases the risk of overfitting. These features may be the best biomarkers for a user’s own data, but not for new samples. Additionally, in order to get a decent ROC curve for validation, it is recommended that the hold-out data contains a balanced number of samples from both groups and that it contain at least 8 hold-out samples (i.e. 4 from each group).</p>
<p>For this module, we will be using the “plasma_nmr_new.csv” file, which has 77 human plasma samples, 12 of which have empty/unknown class labels. Their class will be predicted later using this module. To perform multivariate ROC curve based model creation and evaluation, set the analysis mode to “test” using <em>SetAnalysisMode</em>. Next, prepare the data for biomarker analysis using <em>PrepareROCData</em>. Use <em>CalculateFeatureRanking</em> to view the AUC, t-test, and fold-change for all features. Then users must select a subset of features and samples for model creation and validation. Finally, perform ROC curve analysis with <em>PerformCV.test</em>. With this function, users have the options to select one of three algorithms used for ROC curve analysis (method), to input the number of latent variables if using PLS-DA (lvNums), to choose the proportion of samples used for training (propTraining), and finally to select the the number of MCCV runs to perform (nRuns).<br />
There are several options to visualize the ROC Curve Based Model Creation and Evaluation. The <em>PlotROCTest</em> function creates a plot of the ROC curve for the created biomarker model. The 95% confidence interval can be computed (show.conf = 1). Meanwhile, the <em>PlotProbViewTest</em> function creates a plot of the predicted class probabilities of all samples for the biomarker model. Users have the option to label wrongly classified samples. The <em>PlotAccuracy</em> function creates a box-plot of the predictive accuracy of the biomarker model with predictive accuracy on the y-axis. Users can use <em>GetAccuracyInfo</em> to view the accuracy of the model based on cross-validation and the accuracy of the model based on the held-out data. Using this, users can get a sense of whether or not their model is over-fitted. The typical rule of thumb is that if a model’s performance on the cross-validated data is higher than on the held-out data, the model is likely over-fitted. The <em>Perform.Permute</em> function performs permutations tests using the area under the ROC curve or the predictive accuracy of the model as a measure of performance. Here, users have the option to select the number of permutations to be performed (perm.num) as well as the proportion of samples to be used for training (propTraining). <em>Plot.Permutation</em> will create a plot of the permutations, showing the AUC of all permutations, highlighting the actual observed AUC in blue, along with showing the empirical p-value. This allows users to evaluate the performance of their created model, as the p-value evaluates the fraction of AUCperm greater or equal to the observed AUC. Finally, to view the predicted class labels of unlabeled samples, use <em>ROCPredSamplesTable</em>, which will return a table showing the probability and the predicted class labels for each new sample.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="co"># Set the biomarker analysis mode to perform ROC Curve Based Model Creation and Evaluation (&quot;test&quot;)</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2">mSet&lt;-<span class="kw">SetAnalysisMode</span>(mSet, <span class="st">&quot;test&quot;</span>)</a>
<a class="sourceLine" id="cb16-3" data-line-number="3"></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="co"># Prepare data for biomarker analysis</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5">mSet&lt;-<span class="kw">PrepareROCData</span>(mSet)</a>
<a class="sourceLine" id="cb16-6" data-line-number="6"></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="co"># Perform calculation of feature importance (AUC, p value, fold change)</span></a>
<a class="sourceLine" id="cb16-8" data-line-number="8">mSet&lt;-<span class="kw">CalculateFeatureRanking</span>(mSet)</a>
<a class="sourceLine" id="cb16-9" data-line-number="9"></a>
<a class="sourceLine" id="cb16-10" data-line-number="10"><span class="co"># Manually select a subset of features for ROC analysis to build a classifier </span></a>
<a class="sourceLine" id="cb16-11" data-line-number="11">selected.cmpds &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Betaine&quot;</span>, <span class="st">&quot;N,N-Dimethylglycine&quot;</span>, <span class="st">&quot;Quinolinate&quot;</span>, <span class="st">&quot;Glucose&quot;</span>)</a>
<a class="sourceLine" id="cb16-12" data-line-number="12"></a>
<a class="sourceLine" id="cb16-13" data-line-number="13"><span class="co"># Manually select a subset of samples for ROC analysis hold-out data for validation purposes</span></a>
<a class="sourceLine" id="cb16-14" data-line-number="14">selected.smpls &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;PIF_178&quot;</span>, <span class="st">&quot;PIF_087&quot;</span>, <span class="st">&quot;PIF_090&quot;</span>, <span class="st">&quot;PIF_102&quot;</span>, <span class="st">&quot;PIF_111&quot;</span>, <span class="st">&quot;PIF_112&quot;</span>)</a>
<a class="sourceLine" id="cb16-15" data-line-number="15"></a>
<a class="sourceLine" id="cb16-16" data-line-number="16"><span class="co"># Prepare the custom data for model creation and sample hold-out </span></a>
<a class="sourceLine" id="cb16-17" data-line-number="17">mSet&lt;-<span class="kw">SetCustomData</span>(mSet, selected.cmpds, selected.smpls)</a>
<a class="sourceLine" id="cb16-18" data-line-number="18"></a>
<a class="sourceLine" id="cb16-19" data-line-number="19"><span class="co"># Perform ROC curve analysis, using SVM classification </span></a>
<a class="sourceLine" id="cb16-20" data-line-number="20">mSet&lt;-<span class="kw">PerformCV.test</span>(mSet, <span class="dt">method =</span> <span class="st">&quot;svm&quot;</span>, <span class="dt">lvNum =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb16-21" data-line-number="21"></a>
<a class="sourceLine" id="cb16-22" data-line-number="22"><span class="co"># Plot the ROC curve for the created model</span></a>
<a class="sourceLine" id="cb16-23" data-line-number="23">mSet&lt;-<span class="kw">PlotROC</span>(mSet, <span class="dt">imgName =</span> <span class="st">&quot;cls_roc_0_&quot;</span>, <span class="dt">format=</span><span class="st">&quot;png&quot;</span>,  <span class="dt">dpi=</span><span class="dv">300</span>, <span class="dt">mdl.inx =</span> <span class="dv">0</span>, <span class="dt">avg.method =</span> <span class="st">&quot;threshold&quot;</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="st">&quot;fpr&quot;</span>, <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb16-24" data-line-number="24"></a>
<a class="sourceLine" id="cb16-25" data-line-number="25"><span class="co"># Plot the predicted class probabilities for each sample using the user-created classifier, not showing labels of wrongly classified samples</span></a>
<a class="sourceLine" id="cb16-26" data-line-number="26">mSet&lt;-<span class="kw">PlotProbView</span>(mSet, <span class="dt">imgName =</span> <span class="st">&quot;cls_prob_0_&quot;</span>, <span class="dt">format=</span><span class="st">&quot;png&quot;</span>,  <span class="dt">dpi=</span><span class="dv">300</span>, <span class="dt">mdl.inx =</span><span class="op">-</span><span class="dv">1</span>, <span class="dt">show=</span><span class="dv">0</span>, <span class="dt">showPred=</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb16-27" data-line-number="27"></a>
<a class="sourceLine" id="cb16-28" data-line-number="28"><span class="co"># Plot the predictive accuracy of the model with increasing number of features</span></a>
<a class="sourceLine" id="cb16-29" data-line-number="29">mSet&lt;-<span class="kw">PlotTestAccuracy</span>(mSet, <span class="dt">imgName =</span> <span class="st">&quot;cls_accu_0_&quot;</span>, <span class="dt">format=</span><span class="st">&quot;png&quot;</span>,  <span class="dt">dpi=</span><span class="dv">300</span>)</a>
<a class="sourceLine" id="cb16-30" data-line-number="30"></a>
<a class="sourceLine" id="cb16-31" data-line-number="31"><span class="co"># Perform permutations tests using the area under the ROC curve as a measure of performance</span></a>
<a class="sourceLine" id="cb16-32" data-line-number="32">mSet&lt;-<span class="kw">Perform.Permut</span>(mSet, <span class="dt">perf.measure =</span> <span class="st">&quot;auroc&quot;</span>, <span class="dt">perm.num =</span> <span class="dv">500</span>, <span class="dt">propTraining =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb16-33" data-line-number="33"></a>
<a class="sourceLine" id="cb16-34" data-line-number="34"><span class="co"># Plot the results of the permutation tests</span></a>
<a class="sourceLine" id="cb16-35" data-line-number="35">mSet&lt;-<span class="kw">Plot.Permutation</span>(mSet, <span class="dt">imgName =</span> <span class="st">&quot;roc_perm_1_&quot;</span>, <span class="dt">format=</span><span class="st">&quot;png&quot;</span>,  <span class="dt">dpi=</span><span class="dv">300</span>)</a>
<a class="sourceLine" id="cb16-36" data-line-number="36"></a>
<a class="sourceLine" id="cb16-37" data-line-number="37"><span class="co"># View predicted classes of new samples (only applicable if samples with empty class labels were in the uploaded dataset)</span></a>
<a class="sourceLine" id="cb16-38" data-line-number="38">mSet &lt;-<span class="st"> </span><span class="kw">ROCPredSamplesTable</span>(mSet) <span class="co"># Create table</span></a></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">To view the example of the results<span class="op">:</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="co"># View the the predictive accuracy results of the model</span></a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="co"># &gt;R GetAccuracyInfo(mSet)</span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4">[<span class="dv">1</span>] <span class="st">&quot;The average accuracy based on 100 cross validations is 0.692. The accuracy for hold out data prediction is 0.667(4/6).&quot;</span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5"></a>
<a class="sourceLine" id="cb17-6" data-line-number="6"><span class="co"># View table of new predictions</span></a>
<a class="sourceLine" id="cb17-7" data-line-number="7"><span class="co"># &gt;R mSet$analSet$ROCtest$pred.samples.table </span></a></code></pre></div>
</div>
<div id="sweave-report" class="section level2">
<h2>3. Sweave Report</h2>
<p>To prepare the sweave report, please use the <em>PreparePDFReport</em> function. You must ensure that you have the nexessary Latex libraries to generate the report (i.e. pdflatex, LaTexiT). The object created <em>must</em> be named <em>mSet</em>, and specify the user name in quotation marks.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw">PreparePDFReport</span>(mSet, <span class="st">&quot;My Name&quot;</span>)</a></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
